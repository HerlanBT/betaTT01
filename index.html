<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lector de JSON ‚Üí Tablas por curso + PDF</title>
  <!-- <style>
    :root {
      --bg: #0b1020;
      --panel: #141b34;
      --text: #e8ebf7;
      --muted: #a8b0c7;
      --accent: #5eead4;
      --accent2: #93c5fd;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: system-ui, Segoe UI, Roboto, Ubuntu, Inter, Arial;
      background: var(--bg);
      color: var(--text)
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(180deg, #0b1020 0%, rgba(11, 16, 32, .85) 100%);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid #1f294a
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px
    }

    h1 {
      margin: 0;
      font-size: clamp(18px, 2.5vw, 26px)
    }

    .row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px
    }

    .card {
      background: var(--panel);
      border: 1px solid #1f294a;
      border-radius: 16px;
      padding: 14px
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px
    }

    .controls .card {
      padding: 16px
    }

    label {
      font-size: 12px;
      color: var(--muted)
    }

    input[type="file"],
    textarea {
      width: 100%;
      background: #0f1530;
      color: var(--text);
      border: 1px solid #253156;
      border-radius: 10px;
      padding: 10px
    }

    textarea {
      min-height: 140px;
      resize: vertical
    }

    button {
      cursor: pointer;
      border: 0;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600
    }

    .btn {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0a1022
    }

    .btn-ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid #2a355f
    }

    .badge {
      display: inline-block;
      border: 1px solid #2a355f;
      border-radius: 999px;
      padding: 4px 10px;
      color: var(--muted);
      font-size: 12px
    }

    .courses {
      display: grid;
      gap: 16px;
      margin: 18px 0
    }

    details {
      background: var(--panel);
      border: 1px solid #1f294a;
      border-radius: 16px
    }

    summary {
      list-style: none;
      padding: 14px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    summary::-webkit-details-marker {
      display: none
    }

    .title {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .tables {
      padding: 0 12px 16px
    }

    .table-wrap {
      overflow: auto;
      border: 1px solid #253156;
      border-radius: 14px
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
      background: #0f1530
    }

    thead {
      position: sticky;
      top: 0;
      background: #0e142c;
      z-index: 2
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #1f294a;
      font-size: 13px;
      white-space: nowrap
    }

    th {
      font-weight: 700;
      text-align: left
    }

    tr:hover td {
      background: #10183a
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin: 12px 0
    }

    .search {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .search input {
      min-width: 200px
    }

    .right {
      margin-left: auto
    }

    .footer {
      color: var(--muted);
      font-size: 12px;
      margin-top: 12px
    }
  </style> -->
  <!-- jsPDF + AutoTable (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- css -->
   <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <div class="wrap">
      <h1>Lector de JSON ‚Üí Tabla por curso y exportaci√≥n a PDF</h1>
      
      <div class="row">
        <span class="badge" id="countBadge">0 registros</span>
        <span class="badge" id="courseBadge">0 cursos</span>
      </div>
    </div>
          <div style="margin-top: 20px; text-align: right;">
        <button class="btn" id="exportJSON">Exportar TODO a JSON</button>
      </div>
  </header>

  <main class="wrap">
    <section class="controls">
      <div class="card">
        <label>Subir archivo JSON</label>
        <input type="file" id="fileInput" accept=".json,application/json" />
        <div class="row" style="margin-top:10px">
          <button class="btn" id="loadFileBtn">Cargar desde archivo</button>
          <button class="btn-ghost" id="exampleBtn">Pegar ejemplo</button>
        </div>
      </div>
      <div class="card">
        <label>Pegar JSON aqu√≠ (array de objetos)</label>
        <textarea id="jsonText"
          placeholder='Pega aqu√≠ un array JSON, por ejemplo: [ { "id": 1, "nombre": "...", "curso": "3ro de Secundaria A", ... } ]'></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="loadTextBtn">Cargar desde texto</button>
          <button class="btn-ghost" id="clearBtn">Limpiar</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="toolbar">
        <div class="search">
          <label for="globalSearch">Buscar:</label>
          <input type="text" id="globalSearch" placeholder="Nombre, curso, id..." />
        </div>
        <div class="right">
          <button class="btn" id="exportAll">Exportar TODO a PDF (separado por curso)</button>
        </div>
      </div>
      <div class="courses" id="courses"></div>
      <div class="footer">Consejo: Abre un curso y usa su bot√≥n "Exportar PDF" para exportar solo ese grupo.</div>


    </section>
  </main>

  <!-- <script>
    const state = {
      data: [], grouped: {}, courses: [], columns: [
        { key: 'id', label: 'ID' },
        { key: 'nombre', label: 'Nombre' },
        { key: 'curso', label: 'Curso' },

        { key: 'notaprimertrimestre', label: '1er Trim' },
        { key: 'notasegundotrimestre', label: '2do Trim' },
        { key: 'notatercertrimestre', label: '3er Trim' },
        { key: 'notafinal', label: 'Nota Final' },
        { key: 'exportar', label: 'Exportar', isCheckbox: true }
      ]
    };

    const $ = (q, root = document) => root.querySelector(q);
    const $$ = (q, root = document) => [...root.querySelectorAll(q)];

    function normalizeRow(row) {
      const r = { ...row };
      // Normaliza claves que podr√≠an venir con may√∫sculas/min√∫sculas distintas
      const map = {
        id: 'id', nombre: 'nombre', curso: 'curso', paralelo: 'paralelo', notafinal: 'notafinal', notasegundotrimestre: 'notasegundotrimestre', notatercertrimestre: 'notatercertrimestre', notaprimertrimestre: 'notaprimertrimestre'
      };
      for (const k in row) {
        const kk = k.toLowerCase();
        if (map[kk] && kk !== k) { r[map[kk]] = row[k]; }
      }
      // Asegura todas las columnas
      state.columns.forEach(c => { if (!(c.key in r)) r[c.key] = null; });
      // Limpia curso nulo
      if (!r.curso || typeof r.curso !== 'string') r.curso = 'Sin curso';
      return r;
    }

    function groupByCourse(data) {
      const grouped = {};
      data.forEach(r => {
        const key = String(r.curso).trim();
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(r);
      });
      const courses = Object.keys(grouped).sort((a, b) => a.localeCompare(b, 'es', { numeric: true }));
      return { grouped, courses };
    }

    function render() {
      $('#countBadge').textContent = `${state.data.length} registros`;
      $('#courseBadge').textContent = `${state.courses.length} cursos`;
      const container = $('#courses');
      container.innerHTML = '';
      const q = $('#globalSearch').value.trim().toLowerCase();

      state.courses.forEach(course => {
        const rows = state.grouped[course];
        // Filtrado global
        const filtered = q ? rows.filter(r => Object.values(r).some(v => (v + "")?.toLowerCase().includes(q))) : rows;

        const details = document.createElement('details');
        details.open = true;
        const summary = document.createElement('summary');
        const left = document.createElement('div'); left.className = 'title';
        left.innerHTML = `<strong>${course}</strong> <span class="badge">${filtered.length}/${rows.length} registros</span>`;
        const right = document.createElement('div');
        //creamos este boton en js <button onclick="calcularNotas()">Calcular Notas Finales</button>

        const btnCalc = document.createElement('button');
        btnCalc.className = 'btn';
        btnCalc.textContent = 'Calcular Notas Finales';
        btnCalc.addEventListener('click', e => {
          e.preventDefault();
          calcularNotas(details.querySelector('table')); // le pasamos la tabla del curso
        });
        right.appendChild(btnCalc);
        const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = 'Exportar PDF';
        btn.addEventListener('click', e => { e.preventDefault(); exportCoursePDF(course, filtered); });
        right.appendChild(btn);
        summary.append(left, right);
        const tables = document.createElement('div'); tables.className = 'tables';
        const tableWrap = document.createElement('div'); tableWrap.className = 'table-wrap';
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        state.columns.forEach(c => { const th = document.createElement('th'); th.textContent = c.label; trh.appendChild(th); });
        thead.appendChild(trh); table.appendChild(thead);
        const tbody = document.createElement('tbody');
        filtered.forEach(r => {
          const tr = document.createElement('tr');
          state.columns.forEach(c => {
            const td = document.createElement('td');

            if (c.isCheckbox) {
              const chk = document.createElement('input');
              chk.type = 'checkbox';
              chk.checked = r.exportar !== false; // true por defecto
              chk.addEventListener('change', e => {
                r.exportar = e.target.checked;
              });
              td.appendChild(chk);
            } else {
              let val = r[c.key];
              if (val === null || val === undefined) val = '';
              td.textContent = val;

              if (["notaprimertrimestre", "notasegundotrimestre", "notatercertrimestre"].includes(c.key)) {
                td.contentEditable = "true";
                td.style.backgroundColor = "#1b2540";
                td.style.outline = "none";

                td.addEventListener("input", e => {
                  const newVal = parseFloat(e.target.innerText) || 0;
                  const id = tr.children[getColIndex("id")].innerText;
                  const record = state.data.find(r => String(r.id) === String(id));
                  if (record) record[c.key] = newVal;
                });
              }
            }

            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableWrap.appendChild(table);
        tables.appendChild(tableWrap);
        details.append(summary, tables);
        container.appendChild(details);
      });
    }
    function calcularNotas(table) {
      const tbody = table.querySelector("tbody");

      // √≠ndices de columnas que vamos a usar
      const colExamen = getColIndex("notaexamen");
      const colTrim1 = getColIndex("notaprimertrimestre");
      const colTrim2 = getColIndex("notasegundotrimestre");
      const colTrim3 = getColIndex("notatercertrimestre");
      const colFinal = getColIndex("notafinal");

      if ([colTrim1, colTrim2, colTrim3, colFinal].includes(-1)) {
        alert("Faltan columnas en state.columns");
        return;
      }

      tbody.querySelectorAll("tr").forEach(row => {

        const t1 = parseFloat(row.children[colTrim1]?.innerText) || 0;
        const t2 = parseFloat(row.children[colTrim2]?.innerText) || 0;
        const t3 = parseFloat(row.children[colTrim3]?.innerText) || 0;

        // üëá Aqu√≠ defines tu f√≥rmula real para nota final
        const notaFinal = (t1 + t2 + t3) / 3;

        row.children[colFinal].innerText = notaFinal.toFixed(2);
      });
    }

    function getColIndex(key) {
      return state.columns.findIndex(c => c.key === key);
    }
    function loadData(array) {
      if (!Array.isArray(array)) throw new Error('El JSON debe ser un array de objetos');
      state.data = array.map(normalizeRow);
      const { grouped, courses } = groupByCourse(state.data);
      state.grouped = grouped; state.courses = courses;
      render();
    }

    async function readFileAsText(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onerror = () => rej(new Error('No se pudo leer el archivo'));
        r.onload = () => res(r.result);
        r.readAsText(file);
      });
    }
    const pdfColumns = [
      "id",
      "nombre",
      "notaprimertrimestre",
      "notasegundotrimestre",
      "notatercertrimestre",
      "notafinal"
    ];

    // PDF helpers
    function exportCoursePDF(course, rows) {
      if (!rows || !rows.length) {
        alert('No hay datos para exportar.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      // Encabezado solo con las columnas que quieres
      const head = [state.columns.filter(c => pdfColumns.includes(c.key)).map(c => c.label)];

      // Filtrar solo filas que est√©n marcadas para exportar
      const rowsToExport = rows.filter(r => r.exportar !== false);

      // Generar el body del PDF
      const body = rowsToExport.map((r, i) =>
        pdfColumns.map(k => k === "id" ? i + 1 : r[k] ?? '')
      );

      doc.setFontSize(12);
      doc.text(`Curso: ${course}  ‚Äî  Registros: ${rowsToExport.length}`, 40, 40);

      doc.autoTable({
        startY: 60,
        head: head,
        body: body,
        styles: { fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
        headStyles: { fillColor: [30, 41, 59] },
        alternateRowStyles: { fillColor: [245, 247, 250] },
        theme: 'striped',
        margin: { left: 40, right: 40 }
      });

      doc.save(`Listado_${sanitize(course)}.pdf`);
    }


    function exportAllPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
      let first = true;

      state.courses.forEach(course => {
        const rows = state.grouped[course];

        if (!first) doc.addPage();
        first = false;

        // Encabezado con solo las columnas que quieres exportar
        const head = [state.columns.filter(c => pdfColumns.includes(c.key)).map(c => c.label)];

        // Filtrar solo filas que tengan exportar !== false
        const rowsToExport = rows.filter(r => r.exportar !== false);

        // Body del PDF con ID consecutivo
        const body = rowsToExport.map((r, i) =>
          pdfColumns.map(k => k === "id" ? i + 1 : r[k] ?? '')
        );

        doc.setFontSize(12);
        doc.text(`Curso: ${course}  ‚Äî  Registros: ${rowsToExport.length} - Notas Computacion 2025`, 40, 40);

        doc.autoTable({
          startY: 60,
          head: head,
          body: body,
          styles: { fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
          headStyles: { fillColor: [30, 41, 59] },
          alternateRowStyles: { fillColor: [245, 247, 250] },
          theme: 'striped',
          margin: { left: 40, right: 40 }
        });
      });

      doc.save('Listado_por_curso.pdf');
    }

    function sanitize(s) {
      return String(s).replace(/[^\w\-\u00C0-\u024F\s]/g, '').replace(/\s+/g, '_');
    }

    // Events
    $('#loadFileBtn').addEventListener('click', async () => {
      const f = $('#fileInput').files?.[0];
      if (!f) { alert('Selecciona un archivo .json'); return; }
      try {
        const txt = await readFileAsText(f);
        const data = JSON.parse(txt);
        loadData(data);
      } catch (err) { alert('Error al cargar JSON: ' + err.message); }
    });

    $('#loadTextBtn').addEventListener('click', () => {
      const txt = $('#jsonText').value.trim();
      if (!txt) { alert('Pega el JSON en el cuadro de texto.'); return; }
      try {
        const data = JSON.parse(txt);
        loadData(data);
      } catch (err) { alert('JSON inv√°lido: ' + err.message); }
    });

    $('#clearBtn').addEventListener('click', () => {
      $('#jsonText').value = '';
      state.data = []; state.grouped = {}; state.courses = [];
      render();
    });

    $('#exampleBtn').addEventListener('click', () => {
      const ejemplo = [
        {
          "id": 227,
          "nombre": "LUQUE ESPINOZA LIZANDRO ZAIR",
          "curso": "3ro de Secundaria A",
          "paralelo": null,
          "asistencia": 20,
          "sellos": 4,
          "notaexamen": 30,
          "notafinal": 0,
          "notasegundotrimestre": 0,
          "notatercertrimestre": 0,
          "notaprimertrimestre": 83
        },
        {
          "id": 101,
          "nombre": "ALVAREZ QUISPE MARIA",
          "curso": "3ro de Secundaria A",
          "paralelo": null,
          "asistencia": 18,
          "sellos": 5,
          "notaexamen": 28,
          "notafinal": 80,
          "notasegundotrimestre": 75,
          "notatercertrimestre": 78,
          "notaprimertrimestre": 82
        },
        {
          "id": 302,
          "nombre": "CHOQUE VELASCO LUIS",
          "curso": "3ro de Secundaria B",
          "paralelo": null,
          "asistencia": 19,
          "sellos": 3,
          "notaexamen": 27,
          "notafinal": 77,
          "notasegundotrimestre": 70,
          "notatercertrimestre": 74,
          "notaprimertrimestre": 79
        }
      ];
      $('#jsonText').value = JSON.stringify(ejemplo, null, 2);
    });

    $('#exportAll').addEventListener('click', exportAllPDF);

    // Render inicial
    render();
    function exportFilteredJSONFull() {
      let allRows = [];

      state.courses.forEach(course => {
        const rows = state.grouped[course];

        // Solo filas marcadas para exportar
        const rowsToExport = rows.filter(r => r.exportar !== false);

        rowsToExport.forEach(r => {
          // Creamos una copia para no alterar state.data
          allRows.push({ ...r });
        });
      });

      // Ordenar por nivel educativo y luego por curso/paralelo
      allRows.sort((a, b) => {
        const nivel = s => s.toLowerCase().includes("primaria") ? 1 : 2;
        const nivelA = nivel(a.curso);
        const nivelB = nivel(b.curso);
        if (nivelA !== nivelB) return nivelA - nivelB;

        if (a.curso !== b.curso) return a.curso.localeCompare(b.curso, 'es', { numeric: true });
        if ((a.paralelo ?? '') !== (b.paralelo ?? '')) return (a.paralelo ?? '').localeCompare(b.paralelo ?? '', 'es', { numeric: true });

        return 0;
      });

      // Reiniciar ID consecutivamente
      allRows = allRows.map((r, i) => ({ ...r, id: i + 1 }));

      // Convertir a JSON
      const jsonStr = JSON.stringify(allRows, null, 2);

      // Descargar
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'export_filtrado_completo.json';
      a.click();
      URL.revokeObjectURL(url);
    }
$('#exportJSON').addEventListener('click', () => {
  exportFilteredJSONFull();
});

  </script> -->
  <script src="script.js"></script>
</body>

</html>